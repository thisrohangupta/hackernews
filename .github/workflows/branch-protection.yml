name: Setup Branch Protection

# This workflow sets up branch protection rules for the main branch.
# Run it manually once to configure protection, or on repository creation.
#
# Required: Repository admin permissions and GITHUB_TOKEN with repo scope
# Or use a Personal Access Token (PAT) with admin:repo permissions

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      branch:
        description: 'Branch to protect'
        required: true
        default: 'main'

jobs:
  protect:
    name: Configure Branch Protection
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # Note: Branch protection requires admin permissions
      # You may need to use a PAT instead of GITHUB_TOKEN
    steps:
      - name: Setup Branch Protection
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = '${{ github.event.inputs.branch }}';

            console.log(`Setting up branch protection for: ${branch}`);

            try {
              await github.rest.repos.updateBranchProtection({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branch,
                required_status_checks: {
                  strict: true,  // Require branches to be up to date
                  contexts: [
                    'Build & Lint',
                    'Unit Tests',
                    'Security Scan',
                    'Integration Tests'
                  ]
                },
                enforce_admins: false,  // Allow admins to bypass
                required_pull_request_reviews: {
                  dismiss_stale_reviews: true,
                  require_code_owner_reviews: false,
                  required_approving_review_count: 1
                },
                restrictions: null,  // No user/team restrictions
                required_linear_history: false,
                allow_force_pushes: false,
                allow_deletions: false,
                block_creations: false,
                required_conversation_resolution: true
              });

              console.log('✅ Branch protection configured successfully!');
              console.log('');
              console.log('Protected branch:', branch);
              console.log('Required checks:');
              console.log('  - Build & Lint');
              console.log('  - Unit Tests');
              console.log('  - Security Scan');
              console.log('  - Integration Tests');
              console.log('');
              console.log('Additional settings:');
              console.log('  - Require PR reviews: 1 approval');
              console.log('  - Dismiss stale reviews: Yes');
              console.log('  - Require up-to-date branches: Yes');
              console.log('  - Require conversation resolution: Yes');
              console.log('  - Allow force pushes: No');

            } catch (error) {
              console.error('❌ Failed to set branch protection:', error.message);
              console.log('');
              console.log('This may be due to:');
              console.log('1. Insufficient permissions (need admin access)');
              console.log('2. Branch does not exist');
              console.log('3. Repository is not on a paid plan (some features require paid plans)');
              console.log('');
              console.log('To set up manually, go to:');
              console.log(`https://github.com/${context.repo.owner}/${context.repo.repo}/settings/branches`);
              throw error;
            }
